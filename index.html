<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>SEKTOR 1 - Spiegel der Wahrhaftigkeit</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://8x8.vc/vpaas-magic-cookie-8e05a5a1e2a14e6e9e1f1e1e1e1e1e1e/external_api.js"></script>
    <style>
        :root { --neon: #00ffcc; --bg: #0a0a0a; --dark: #050505; --warn: #ff0055; }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; }

        /* Das Dashboard */
        .header-main { border-bottom: 2px solid var(--neon); padding: 20px; text-align: center; background: #000; box-shadow: 0 0 20px rgba(0,255,204,0.3); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding: 40px; max-height: 80vh; overflow-y: auto; }
        
        .box { 
            background: var(--dark); border: 1px solid #333; height: 120px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .box:hover { border-color: var(--neon); transform: scale(1.05); box-shadow: 0 0 30px var(--neon); color: #000; background: var(--neon); }
        .box::before { content: "LIVE"; position: absolute; top: 10px; right: 10px; font-size: 9px; color: var(--warn); animation: blink 1s infinite; }
        
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

        /* Das Drawer-System (Die Welt in der Welt) */
        #drawer { position: fixed; inset: 0; background: #000; transform: translateX(100%); transition: 0.6s ease; z-index: 1000; display: flex; }
        #drawer.active { transform: translateX(0); }

        #video-area { flex: 3; background: #000; position: relative; }
        #side-panel { flex: 1; border-left: 1px solid var(--neon); display: flex; flex-direction: column; background: #050505; }

        /* Chat & Info */
        .chat-header { padding: 15px; border-bottom: 1px solid var(--neon); font-weight: bold; }
        #chat-msgs { flex: 1; overflow-y: auto; padding: 15px; font-size: 13px; line-height: 1.5; }
        .input-area { padding: 15px; border-top: 1px solid #222; display: flex; gap: 5px; }
        input { flex: 1; background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 10px; outline: none; }
        
        .btn-sub { width: 100%; padding: 15px; background: none; border: none; border-top: 1px solid var(--neon); color: var(--neon); cursor: pointer; font-weight: bold; }
        .btn-sub:hover { background: var(--neon); color: #000; }

        .close-btn { position: absolute; top: 20px; left: -50px; width: 50px; height: 50px; background: var(--neon); color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 30px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-main">
        <h1>SPIEGEL DER WAHRHAFTIGKEIT</h1>
        <p>Sektor 1: Maschine im Dienst der Seele</p>
    </div>

    <div class="grid-container" id="grid"></div>

    <div id="drawer">
        <div class="close-btn" onclick="exit()">X</div>
        <div id="video-area"></div>
        <div id="side-panel">
            <div class="chat-header" id="status-title">SEKTOR X - TISCH 1</div>
            <div id="chat-msgs"></div>
            <div class="input-area">
                <input type="text" id="chat-in" placeholder="Wahrheit eingeben...">
                <button onclick="send()" style="background:var(--neon); border:none; padding:10px; cursor:pointer;">OK</button>
            </div>
            <button class="btn-sub" onclick="showProtocoll()">PROTOKOLL ANZEIGEN</button>
        </div>
    </div>

    <script>
        const grid = document.getElementById('grid');
        const drawer = document.getElementById('drawer');
        const videoArea = document.getElementById('video-area');
        const chatMsgs = document.getElementById('chat-msgs');
        const chatIn = document.getElementById('chat-in');

        // ABly & Tisch-Logik
        const ably = new Ably.Realtime('I0i7_A.Yp_6dA:z40pTfKj8_GvP0_T');
        let currentChannel;

        // Erstelle 20 Sektoren
        for (let i = 1; i <= 20; i++) {
            let b = document.createElement('div');
            b.className = 'box';
            b.innerHTML = `<span>SEKTOR</span><strong style="font-size:24px">${i}</strong>`;
            b.onclick = () => enter(i);
            grid.appendChild(b);
        }

        async function enter(id) {
            drawer.classList.add('active');
            
            // AUTOMATISIERUNG: Wir prüfen "virtuell" die Auslastung
            // In der finalen Version würde hier eine Abfrage an Ably gehen: "Wie viele Leute sind in Raum X?"
            // Wenn > 8, dann Tisch++
            let tisch = 1; 
            let roomName = `Wahrheit_Sektor_${id}_Tisch_${tisch}`;
            document.getElementById('status-title').innerText = `SEKTOR ${id} - TISCH ${tisch}`;

            // Jitsi Video (8 Slots garantiert)
            videoArea.innerHTML = "";
            new JitsiMeetExternalAPI("meet.jit.si", {
                roomName: roomName, width: "100%", height: "100%", parentNode: videoArea,
                configOverwrite: { startWithAudioMuted: true }
            });

            // Ably Chat
            chatMsgs.innerHTML = `<div style="color: #666">Sektor ${id} Protokoll gestartet...</div>`;
            currentChannel = ably.channels.get('chat-' + id);
            currentChannel.subscribe('m', (msg) => {
                let d = document.createElement('div');
                d.innerHTML = `<span style="color:var(--neon)">></span> ${msg.data}`;
                d.style.marginBottom = "8px";
                chatMsgs.appendChild(d);
                chatMsgs.scrollTop = chatMsgs.scrollHeight;
            });
        }

        function send() {
            if(chatIn.value && currentChannel) {
                currentChannel.publish('m', chatIn.value);
                chatIn.value = '';
            }
        }

        function exit() {
            drawer.classList.remove('active');
            videoArea.innerHTML = "";
            if(currentChannel) currentChannel.unsubscribe();
        }

        function showProtocoll() {
            alert("PROTOKOLL SEKTOR 1:\nDie Maschine im Dienst der Seele. Du bist der Ursprung.");
        }

        chatIn.onkeypress = (e) => { if(e.key==='Enter') send(); };
    </script>
</body>
</html>
