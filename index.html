<script>
    // --- GLOBALE VARIABLEN & STATUS ---
    let userBackstage = { 
        sektorZeiten: Array(20).fill(0), 
        isQualifiziert: false, 
        isVerifiziert: false, 
        stammSektor: null, 
        rankingPlatz: 5 
    };

    const themen = [
        "Recht auf Gefühls Forderung", "Wie werde ich Mensch", "Glaube an Friede", 
        "Programm für Bürgerliche Rechte", "Moralische Pflicht und Verantwortung", 
        "Menschlichkeit Wiederherstellung", "Kinderschutz-Pflicht-Elternrechte", 
        "Wahre Richtung und Kunst", "LGBTQ und Kirche", "Trend and Tradition", 
        "Religionsbekenntnis oder Selbstwahl", "Gesundheitswesen und Verhalten", 
        "Arbeitswelt und Du", "Mobbing am Arbeitsplatz", "Jugendsprecher", 
        "Ratgeber für Pensionisten", "Sozialgefallen und Widerkehr", 
        "Nachbarschaft und Gemeinschaft", "Mensch und Technik", "Die Brücke"
    ];

    let ebene = 1;
    let tId = 0;
    let aktuellesThema = "";
    let wechselInterval;
    let geleseneThemen = new Set();
    let interaktionsZaehler = {};

    // Initialisierung des Zählers
    themen.forEach((t, i) => { interaktionsZaehler[i] = 0; });

    // --- GRID INITIALISIERUNG ---
    const grid = document.getElementById('main-grid');
    themen.forEach((t, i) => { 
        grid.innerHTML += `<div class="box" id="box-${i}"><div class="num num-neutral" id="num-${i}">${i+1}</div><div class="text" onclick="checkAccess(${i}, '${t}')">${t}</div></div>`; 
    });
    
    // --- SCHUBLADEN (EBENE 4) INITIALISIERUNG ---
    const drawerArea = document.getElementById('sektoren-schubladen');
    themen.forEach((t, i) => {
        drawerArea.innerHTML += `
            <div class="schublade" id="drawer-${i}">
                <div class="schublade-header" onclick="toggleDrawer(${i})">
                    <span>SEKTOR ${i+1}: ${t}</span>
                    <span id="arrow-${i}">▼</span>
                </div>
                <div class="schublade-content">
                    <p>Hinterlegen Sie hier Dokumente oder Gedanken zum Thema "${t}".</p>
                    <textarea id="note-${i}" class="schublade-textarea" placeholder="Hier tippen..."></textarea>
                    <br>
                    <button class="save-btn" onclick="saveNote(${i})">DOKUMENT SICHERN</button>
                </div>
            </div>`;
    });

    const dots = document.getElementById('dot-holder');
    for(let i=1; i<=7; i++) dots.innerHTML += `<div id="dot${i}" class="dot ${i===1?'active':''}"></div>`;

    // --- FUNKTIONEN ---

    function saveNote(id) {
        alert("Dokument für Sektor " + (id+1) + " lokal gesichert.");
    }

    function showZugangInfo(typ) {
        const modal = document.getElementById('zugang-modal');
        const titel = document.getElementById('modal-titel');
        const text = document.getElementById('modal-text');
        const emailField = document.getElementById('email-input-field');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        modal.style.display = 'flex';
        
        if(typ === 'gast') {
            titel.innerText = "Gast-Modus";
            text.innerText = "Dein Fortschritt wird nur lokal gespeichert.";
            emailField.style.display = 'none';
            confirmBtn.onclick = () => { userBackstage.isVerifiziert = false; modal.style.display = 'none'; updateUI(); };
        } else {
            titel.innerText = "Verifizierter Status";
            text.innerText = "Alle freigeschalteten Sektoren bleiben dauerhaft gesichert.";
            emailField.style.display = 'block';
            confirmBtn.onclick = () => { 
                const mail = document.getElementById('user-email-input').value;
                if(mail.includes('@')) { 
                    userBackstage.isVerifiziert = true; 
                    modal.style.display = 'none'; 
                    updateUI(); 
                    alert("Erfolgreich verifiziert!"); 
                } else { 
                    alert("E-Mail ungültig."); 
                }
            };
        }
    }

    function checkAccess(id, t) {
        if (userBackstage.isVerifiziert || geleseneThemen.has(id) || id === 0 || geleseneThemen.size >= id) { 
            showInfo(t, id); 
        } else { 
            alert("Bitte halten Sie die Reihenfolge der Sektoren ein!"); 
        }
    }

    function toggleDrawer(id) {
        const d = document.getElementById(`drawer-${id}`);
        const arrow = document.getElementById(`arrow-${id}`);
        const isOpen = d.classList.contains('open');
        document.querySelectorAll('.schublade').forEach(s => s.classList.remove('open'));
        document.querySelectorAll('.schublade-header span[id^="arrow"]').forEach(a => a.innerText = '▼');
        if (!isOpen) { d.classList.add('open'); arrow.innerText = '▲'; }
    }

    function adminUnlock() {
        themen.forEach((_, i) => { geleseneThemen.add(i); interaktionsZaehler[i] = 20; });
        userBackstage.isQualifiziert = true;
        userBackstage.isVerifiziert = true;
        updateNumColors();
        updateUI();
        alert("ADMIN MODUS AKTIVIERT");
    }

    function showInfo(t, id) { 
        tId = id; 
        aktuellesThema = t; 
        
        const chatBox = document.getElementById('chat-box');
        if(chatBox) chatBox.innerHTML = "<i>System: Dialog für " + t + " bereit...</i>";
        
        const input = document.getElementById('chat-input');
        if(input) input.value = "";

        const fundamentAbgeschlossen = geleseneThemen.has(19);

        if (userBackstage.isVerifiziert && fundamentAbgeschlossen) { 
            ebene = 3; 
        } else { 
            ebene = 2; 
            geleseneThemen.add(id); 
        }
        
        updateNumColors(); 
        document.getElementById('dashboard').style.display = 'none'; 
        document.getElementById('page-skelett').style.display = 'flex'; 
        updateUI(); 
    } 

    function portalZuEbene3() { if (document.getElementById('sig-r4').classList.contains('signal-aktiv')) { ebene = 3; updateUI(); } }
    
    function portalZuEbene4() { 
        if (document.getElementById('sig-l4').classList.contains('signal-aktiv')) { 
            const modal = document.getElementById('video-wahl-modal');
            const liste = document.getElementById('wahl-liste');
            liste.innerHTML = "";
            themen.forEach((t, i) => {
                liste.innerHTML += `<div onclick="setzeSektorUndVideo(${i}, '${t}')" style="border:1px solid #fff; padding:10px; cursor:pointer; text-align:center; font-size:0.8rem;">SEKTOR ${i+1}:<br>${t}</div>`;
            });
            modal.style.display = 'flex';
        } 
    }

    function setzeSektorUndVideo(id, t) {
        tId = id; aktuellesThema = t; ebene = 4;
        document.getElementById('video-wahl-modal').style.display = 'none';
        updateUI();
    }

    function portalZuEbene5() { if (document.getElementById('sig-l1').classList.contains('elite-aktiv')) { ebene = 5; updateUI(); } }

    function updateUI() {
        const isChat = (ebene === 3), isVideo = (ebene === 4), isAdmin = (ebene === 5);
        document.getElementById('chat-area').style.display = isChat ? 'flex' : 'none';
        document.getElementById('drawer-ebene4').style.display = isVideo ? 'flex' : 'none';
        document.getElementById('ebene5-bereich').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('lila-balken-container').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('main-text').style.display = (ebene < 3) ? 'block' : 'none';
        
        const redBar = document.getElementById('ebene4-title-red');
        if (isVideo) {
            redBar.style.display = 'block';
            redBar.innerText = `SEKTOR: ${aktuellesThema}`;
        } else {
            redBar.style.display = 'none';
        }

        document.getElementById('info-titel').style.display = (isVideo || isAdmin) ? 'none' : 'block';
        document.getElementById('counter-box').style.display = ebene >= 3 ? 'block' : 'none';
        document.getElementById('btn-back').style.visibility = 'visible';
        document.getElementById('info-titel').innerText = aktuellesThema;
        if (ebene === 2) document.getElementById('main-text').innerText = "Inhalt für " + aktuellesThema + "...";

        const nextBtn = document.getElementById('btn-next');
        if (tId >= 19 || ebene >= 4) {
            nextBtn.style.visibility = 'hidden';
        } else if (userBackstage.isVerverified && (ebene === 2 || ebene === 3)) {
            nextBtn.style.visibility = 'visible';
        } else {
            nextBtn.style.visibility = (ebene < 7 && ebene !== 2 && ebene !== 3) ? 'visible' : 'hidden';
        }

        // Signal-Logik
        const sigGelb = document.getElementById('sig-r4');
        const sigRot = document.getElementById('sig-l4');
        const sigL1 = document.getElementById('sig-l1');

        if (ebene === 2) sigGelb.classList.toggle('signal-aktiv', geleseneThemen.size === 20);
        else sigGelb.classList.remove('signal-aktiv');

        if (ebene === 3) {
            let alleFertig = Object.values(interaktionsZaehler).every(val => val >= 20);
            sigRot.classList.toggle('signal-aktiv', alleFertig);
        } else sigRot.classList.remove('signal-aktiv');

        if (userBackstage.isQualifiziert && ebene < 5) {
            sigL1.className = "oval-side elite-aktiv";
            sigL1.onclick = portalZuEbene5;
        } else {
            sigL1.className = "oval-side ov-schwarz";
            sigL1.onclick = null;
        }

        updateDots(); 
        startRotation();
    }

    function updateDots() { 
        for(let i=1; i<=7; i++) { 
            const d = document.getElementById('dot'+i); 
            if(d) d.classList.toggle('active', i === ebene); 
        } 
    }
    
    function nextPage() { 
        if (userBackstage.isVerifiziert && (ebene === 2 || ebene === 3) && tId < 19) { 
            tId++; 
            aktuellesThema = themen[tId];
            if (ebene === 2) geleseneThemen.add(tId);
            updateUI(); 
            updateNumColors();
        } else if (ebene < 7 && ebene !== 2 && ebene !== 3 && ebene !== 4 && ebene !== 5) { 
            ebene++; 
            updateUI(); 
        } 
    }

    function showDashboard() { 
        ebene = 1; 
        document.getElementById('page-skelett').style.display = 'none'; 
        document.getElementById('dashboard').style.display = 'flex'; 
        updateNumColors(); 
    }
    
    function registriereSenden() { 
        const input = document.getElementById('chat-input'), chatBox = document.getElementById('chat-box'), text = input.value.trim(); 
        if (text === "") return; 
        chatBox.innerHTML += `<div style="margin-bottom: 8px;"><strong>Du:</strong> ${text}</div>`; 
        if (interaktionsZaehler[tId] < 20) interaktionsZaehler[tId]++; 
        input.value = ""; 
        chatBox.scrollTop = chatBox.scrollHeight; 
        updateUI(); 
    }

    function updateNumColors() {
        themen.forEach((_, i) => {
            const nBox = document.getElementById(`num-${i}`);
            if (nBox) {
                if (interaktionsZaehler[i] >= 20) nBox.className = "num num-fertig";
                else if (interaktionsZaehler[i] > 0) nBox.className = "num num-offen";
                else if (geleseneThemen.has(i)) nBox.className = "num num-gelesen";
                else nBox.className = "num num-neutral";
            }
        });
    }

    function startRotation() { 
        clearInterval(wechselInterval); 
        const bg = document.getElementById('werbe-bg'); 
        if(!bg) return; 
        bg.style.backgroundImage = `url('https://picsum.photos/seed/${tId + ebene}/1200/600')`; 
        bg.classList.add('bild-aktiv'); 
    }

    async function starteVideoKonferenz() {
        const meinSlot = document.getElementById('v-slot-1');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            meinSlot.innerHTML = `<video id="user-video" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>`;
            document.getElementById('user-video').srcObject = stream;
        } catch (err) { alert("Kamera-Fehler: Bitte Zugriff erlauben."); }
    }
</script>
