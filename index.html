<!DOCTYPE html><html lang="de"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M&M Dashboard - Final Fix</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src='https://8x8.vc/vpaas-magic-cookie-39f826359e1345d38f8304910901e855/external_api.js'></script>
    <style>
        :root { --gold: #ffd700; --bg: #0a0a0a; --card: #1a1a1a; --text: #e0e0e0; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; }
        .dashboard { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; width: 100%; max-width: 1200px; }
        .box { background: var(--card); border-radius: 10px; padding: 15px; border: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .num { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .num-fertig { background: var(--gold); color: #000; }
        
        #page-skelett { display: none; position: fixed; inset: 0; background: #000; flex-direction: column; z-index: 1000; }
        .header-skelett { height: 60px; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #111; }
        .content-skelett { flex: 1; padding: 20px; overflow-y: auto; color: #fff; }
        .footer-skelett { height: 60px; border-top: 1px solid #222; display: flex; align-items: center; justify-content: center; gap: 20px; }
        
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #333; cursor: pointer; }
        .dot.active { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        
        #chat-area { display: none; flex-direction: column; height: 100%; }
        #chat-box { flex: 1; border: 1px solid #222; padding: 10px; overflow-y: auto; background: #050505; margin-bottom: 10px; min-height: 200px; }
        
        #jitsi-container-small { display: none; height: 500px; width: 100%; border: 1px solid #gold; background: #000; }
        textarea { width: 100%; background: #111; color: #fff; border: 1px solid #333; padding: 10px; }
    </style>
</head>
<body>

<div id="dashboard" class="dashboard">
    <h1 style="color:var(--gold)">M&M DASHBOARD</h1>
    <div id="main-grid" class="grid"></div>
</div>

<div id="page-skelett">
    <div class="header-skelett">
        <button onclick="location.reload()" class="btn" style="background:none; color:var(--gold); border:1px solid var(--gold); cursor:pointer;">Zur端ck</button>
        <div id="info-titel">Sektor</div>
        <button onclick="nextPage()" style="background:var(--gold); border:none; padding: 10px; cursor:pointer; font-weight:bold;">WEITER</button>
    </div>
    <div class="content-skelett">
        <div id="main-text" style="font-size: 1.2rem; line-height: 1.5;"></div>
        
        <div id="chat-area">
            <div id="chat-box"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chat-input" style="flex:1; padding:10px; background:#111; color:#fff; border:1px solid #333;">
                <button onclick="registriereSenden()" style="padding:10px; background:var(--gold); border:none; cursor:pointer;">Senden</button>
            </div>
        </div>

        <div id="jitsi-container-small"></div>
        
        <div id="notiz-area" style="display:none; margin-top:20px;">
            <h3 style="color:var(--gold)">DOKUMENTATION</h3>
            <textarea id="note-current" rows="5"></textarea>
            <button onclick="saveNote()" style="margin-top:10px; padding:10px; background:var(--gold); border:none; cursor:pointer;">Sichern</button>
        </div>
    </div>
    <div class="footer-skelett" id="dot-holder"></div>
</div>

<script>
    let userBackstage = JSON.parse(localStorage.getItem('mm_user_data')) || { sektorNotizen: {}, besuchteSektoren: [], isVerifiziert: false };
    const themen = ["Gef端hlsvorderung", "Mensch werden", "Friede", "B端rgerrechte", "Moral", "Wiederherstellung", "Kinderschutz", "Kunst", "Kirche", "Tradition", "Religion", "Gesundheit", "Arbeit", "Mobbing", "Jugend", "Pensionisten", "Gemeinschaft", "Soziales", "Alleinerziehend", "Die Br端cke"];

    let ebene = 1, tId = 0, jitsiApi = null;
    const ably = new Ably.Realtime('IO8wIA.C7HVjQ:SdzgpyD0_ilg8UOO-mXm94ro0VtTUSao8HUMoW7538sA');

    function initApp() {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "";
        themen.forEach((t, i) => {
            const fertig = userBackstage.besuchteSektoren.includes(i) ? 'num-fertig' : '';
            grid.innerHTML += `<div class="box" onclick="startSektor(${i})"><div class="num ${fertig}">${i+1}</div><div>${t}</div></div>`;
        });
        const dots = document.getElementById('dot-holder');
        dots.innerHTML = "";
        for(let i=1; i<=4; i++) dots.innerHTML += `<div id="dot${i}" class="dot"></div>`;
    }

    function startSektor(id) {
        tId = id;
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('page-skelett').style.display = 'flex';
        setEbene(1);
    }

    function setEbene(n) {
        ebene = n;
        // Reset Sichtbarkeit
        document.getElementById('main-text').style.display = 'none';
        document.getElementById('chat-area').style.display = 'none';
        document.getElementById('jitsi-container-small').style.display = 'none';
        document.getElementById('notiz-area').style.display = 'none';

        document.getElementById('info-titel').innerText = "Sektor " + (tId + 1) + " - Ebene " + n;

        if(n === 1) {
            document.getElementById('main-text').style.display = 'block';
            document.getElementById('main-text').innerText = "Willkommen in Sektor " + (tId+1) + ". Hier beginnt die Analyse der Themengebiete...";
        } else if(n === 2) {
            document.getElementById('main-text').style.display = 'block';
            document.getElementById('main-text').innerText = "Ebene 2: Vertiefung und Struktur. Hier werden die Fakten gesammelt.";
        } else if(n === 3) {
            document.getElementById('chat-area').style.display = 'flex';
            verbindeChat();
        } else if(n === 4) {
            document.getElementById('jitsi-container-small').style.display = 'block';
            document.getElementById('notiz-area').style.display = 'block';
            document.getElementById('note-current').value = userBackstage.sektorNotizen[tId] || "";
            setTimeout(starteVideo, 200);
        }

        document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === n-1));
    }

    function nextPage() {
        if(ebene < 4) setEbene(ebene + 1);
        else location.reload();
    }

    function verbindeChat() {
        const channel = ably.channels.get('chat_sektor_' + tId);
        channel.subscribe('msg', (m) => {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div><b>Nutzer:</b> ${m.data}</div>`;
            box.scrollTop = box.scrollHeight;
        });
    }

    function registriereSenden() {
        const input = document.getElementById('chat-input');
        if(!input.value) return;
        ably.channels.get('chat_sektor_' + tId).publish('msg', input.value);
        input.value = "";
    }

    function starteVideo() {
        if(jitsiApi) jitsiApi.dispose();
        const domain = "8x8.vc";
        const options = {
            roomName: "vpaas-magic-cookie-39f826359e1345d38f8304910901e855/MM_Sektor_Room_" + tId,
            parentNode: document.getElementById('jitsi-container-small'),
            height: 500
        };
        jitsiApi = new JitsiMeetExternalAPI(domain, options);
    }

    function saveNote() {
        userBackstage.sektorNotizen[tId] = document.getElementById('note-current').value;
        if(!userBackstage.besuchteSektoren.includes(tId)) userBackstage.besuchteSektoren.push(tId);
        localStorage.setItem('mm_user_data', JSON.stringify(userBackstage));
        alert("Gespeichert!");
    }

    initApp();
</script>
</body></html>
